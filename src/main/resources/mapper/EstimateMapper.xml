<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- Mapperとxmlのマッピング -->
<mapper
	namespace="com.kenchiku_estimator.repository.EstimateMapper">

	<!-- 見積書のマッピング -->

	<!-- 見積書の一覧を取得 -->
	<select id="findAll"
		resultType="com.kenchiku_estimator.model.Estimate">
		SELECT e.id,
		e.estimate_number,
		e.title,
		e.client_name AS clientName,
		e.created_by,
		e.created_at,
		a.full_name AS fullName
		FROM estimates e
		LEFT JOIN accounts a ON e.created_by = a.id
		ORDER BY e.created_at DESC
	</select>
	<!-- 検索ワードに該当する見積書を取得 -->
	<select id="findBySearchWords" parameterType="String"
		resultType="com.kenchiku_estimator.model.Estimate">
		SELECT e.id,
		e.estimate_number,
		e.title,
		e.client_name AS clientName,
		e.created_by,
		e.created_at,
		a.full_name AS fullName
		FROM estimates e
		LEFT JOIN accounts a ON e.created_by = a.id
		WHERE e.title LIKE CONCAT('%', #{searchWords}, '%')
		OR e.client_name LIKE CONCAT('%', #{searchWords}, '%')
		OR e.estimate_number LIKE CONCAT('%', #{searchWords}, '%')
		OR e.id = #{searchWords}
		ORDER BY e.created_at DESC
	</select>
	<!-- IDで見積書を取得 -->
	<select id="findById" parameterType="int"
		resultType="com.kenchiku_estimator.model.Estimate">
		SELECT e.id,
		e.estimate_number,
		e.title,
		e.client_name AS clientName,
		e.created_by,
		e.created_at,
		a.full_name AS fullName
		FROM estimates e
		LEFT JOIN accounts a ON e.created_by = a.id
		WHERE e.id = #{id}
	</select>
	<!-- 新規登録 -->
	<insert id="insertEstimate"
		parameterType="com.kenchiku_estimator.model.Estimate"
		useGeneratedKeys="true" keyProperty="id">
		INSERT INTO estimates
		(estimate_number, title, client_name,created_by, created_at)
		VALUES
		(#{estimateNumber}, #{title}, #{clientName}, #{createdBy}, CURRENT_DATE)
	</insert>
	<!-- 更新 -->
	<update id="updateEstimate"
		parameterType="com.kenchiku_estimator.model.Estimate">
		UPDATE estimates
		SET title = #{title}, client_name = #{clientName}, created_by = #{createdBy}, created_at =
		CURRENT_DATE
		WHERE id = #{id}
	</update>
	<!-- 削除 -->
	<delete id="deleteEstimate" parameterType="int">
		DELETE
		FROM estimates
		WHERE id = #{id}
	</delete>
	<!-- 見積番号の接頭辞で件数をカウント -->
	<select id="countByEstimateNumberPrefix" resultType="int"
		parameterType="String">
		SELECT COUNT(*)
		FROM estimates
		WHERE estimate_number LIKE CONCAT(#{prefix}, '%')
	</select>
	<!-- 担当している見積書の件数をカウント -->
	<select id="countByCreatedBy" resultType="int"
		parameterType="int"> SELECT COUNT(*) FROM estimates WHERE created_by =
		#{accountId}
	</select>

</mapper>
