<!-- templates/estimates/edit.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/commonLayout}">

<head>
<meta charset="UTF-8">
<title>見積書編集</title>
</head>

<body>
  <div layout:fragment="content">
    <h1 class="mb-4">見積書 編集</h1>

    <form id="editForm" class="mb-3 row g-2" th:action="@{/estimates/edit/{id}(id=${estimateForm.id})}" method="post" th:object="${estimateForm}">
      <div class="col-4">
        <label for="title" class="form-label">件名</label>
        <input type="text" th:field="*{title}" class="form-control" id="title">
        <th:block th:with="fieldName='title'">
          <div th:if="${#fields.hasErrors(fieldName)}" th:errors="*{title}" class="text-danger"></div>
        </th:block>
        <div class="form-text">※100文字以内</div>
      </div>

      <div class="col-4">
        <label for="clientName" class="form-label">顧客名</label>
        <input type="text" th:field="*{clientName}" class="form-control">
        <th:block th:with="fieldName='clientName'">
          <div th:if="${#fields.hasErrors(fieldName)}" th:errors="*{clientName}" class="text-danger"></div>
        </th:block>
        <div class="form-text">※100文字以内</div>
      </div>

      <div class="col-4">
        <label for="createdBy" class="form-label">担当者</label> <select class="form-select" id="createdBy" name="createdBy" th:field="*{createdBy}">
          <option th:each="account : ${fullNameList}" th:value="${account.id}" th:text="${account.fullName}" th:selected="${account.id} == ${selectedAccountId}"></option>
        </select>
        <th:block th:with="fieldName='createdBy'">
          <div th:if="${#fields.hasErrors(fieldName)}" th:errors="*{createdBy}" class="text-danger"></div>
        </th:block>
      </div>

      <!-- 内訳テーブル -->
      <h4 class="mt-4">内訳</h4>
      <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
          <div class="row g-3 align-items-start">
            <div class="col-12 col-lg-10">
              <div class="table-responsive mb-3">
                <table class="table table-bordered" id="items">
                  <thead class="table-light">
                    <tr>
                      <th>資材・作業名</th>
                      <th>単価</th>
                      <th>数量</th>
                      <th>単位</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="item, stat : *{items}">
                      <td>
                        <input type="hidden" th:field="*{items[__${stat.index}__].id}" />
                        <input type="hidden" th:field="*{items[__${stat.index}__].estimateId}" />
                        <input type="text" th:field="*{items[__${stat.index}__].itemName}" class="form-control" placeholder="資材・作業名">
                        <th:block th:with="fieldName=${'items[' + stat.index + '].itemName'}">
                          <div th:if="${#fields.hasErrors(fieldName)}" th:errors="*{items[__${stat.index}__].itemName}" class="text-danger"></div>
                        </th:block>
                      </td>
                      <td>
                        <input type="number" step="0.01" th:field="*{items[__${stat.index}__].unitPrice}" class="form-control" placeholder="単価">
                        <th:block th:with="fieldName=${'items[' + stat.index + '].unitPrice'}">
                          <div th:if="${#fields.hasErrors(fieldName)}" th:errors="*{items[__${stat.index}__].unitPrice}" class="text-danger"></div>
                        </th:block>
                      </td>
                      <td>
                        <input type="number" step="0.01" th:field="*{items[__${stat.index}__].quantity}" class="form-control" placeholder="数量">
                        <th:block th:with="fieldName=${'items[' + stat.index + '].quantity'}">
                          <div th:if="${#fields.hasErrors(fieldName)}" th:errors="*{items[__${stat.index}__].quantity}" class="text-danger"></div>
                        </th:block>
                      </td>
                      <td>
                        <input type="text" th:field="*{items[__${stat.index}__].unit}" class="form-control" placeholder="単位">
                        <th:block th:with="fieldName=${'items[' + stat.index + '].unit'}">
                          <div th:if="${#fields.hasErrors(fieldName)}" th:errors="*{items[__${stat.index}__].unit}" class="text-danger"></div>
                        </th:block>
                      </td>
                      <td style="width: 75px;">
                        <button type="button" class="btn btn-danger" th:onclick="'removeItem(this)'">削除</button>
                      </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(estimateForm.items)}">
                      <td colspan="5" class="text-center">内訳項目がありません</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-12 col-lg-2 d-flex flex-column gap-2">
              <div>
                <label class="form-label">合計金額（税抜）</label>
                <input type="text" id="totalAmount" class="form-control" readonly>
              </div>
              <div>
                <label class="form-label">消費税</label>
                <input type="text" id="taxAmount" class="form-control" readonly>
              </div>
              <div>
                <label class="form-label">合計金額（税込）</label>
                <input type="text" id="grandTotal" class="form-control" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row align-items-end mb-3">
        <!-- 内訳追加ボタン -->
        <div class="col-2 d-flex flex-column justify-content-end">
          <button type="button" class="btn btn-secondary" onclick="addItem()">内訳を追加</button>
        </div>
      </div>

      <div class=" row">
        <div class="col-4">
          <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger">入力内容にエラーがあります。各項目を確認してください。</div>
        </div>
        <div class="col-4">
          <!-- 登録ボタン -->
          <div class="mb-3">
            <button type="submit" name="action" value="update" class="btn btn-primary">更新</button>
            <button type="submit" name="action" value="saveAsNew" class="btn btn-success">別件で保存</button>
            <a th:href="@{/estimates}" class="btn btn-secondary">キャンセル</a>
          </div>
        </div>
      </div>
    </form>

    <!-- 内訳項目のテンプレート-->
    <template id="itemRowTemplate">
      <tr>
        <td>
          <input type="text" name="items[__index__].itemName" class="form-control">
        </td>
        <td>
          <input type="number" name="items[__index__].unitPrice" step="0.01" class="form-control">
        </td>
        <td>
          <input type="number" name="items[__index__].quantity" step="0.01" class="form-control">
        </td>
        <td>
          <input type="text" name="items[__index__].unit" class="form-control">
        </td>
        <td>
          <button type="button" class="btn btn-danger" onclick="removeItem(this)">削除</button>
        </td>
      </tr>
    </template>

  </div>

  <div layout:fragment="script">
    <script>
            function addItem() {
                const tbody = document.querySelector("#items tbody");
                const index = tbody.children.length;
                const template = document.querySelector("#itemRowTemplate").innerHTML;
                const rowHtml = template.replace(/__index__/g, index);
                const tempDiv = document.createElement("tbody");
                tempDiv.innerHTML = rowHtml;
                const newRow = tempDiv.querySelector("tr");

                tbody.appendChild(newRow);
            }

            function removeItem(button) {
                const row = button.closest("tr");
                if (row) {
                    row.remove();
                }
            }

            function calculateTotal() {
                const items = document.querySelectorAll("#items tbody tr");
                let subtotal = 0;

                items.forEach(item => {
                    const unitPrice = parseFloat(item.querySelector("input[name$='.unitPrice']").value) || 0;
                    const quantity = parseFloat(item.querySelector("input[name$='.quantity']").value) || 0;
                    subtotal += unitPrice * quantity;
                });
                
                const tax = subtotal * 0.1; // 10%の消費税
                const total = subtotal + tax;
                
                document.getElementById("totalAmount").value = subtotal.toFixed(0);
                document.getElementById("taxAmount").value = tax.toFixed(0);
                document.getElementById("grandTotal").value = total.toFixed(0);
            }
            document.addEventListener("DOMContentLoaded", function () {
                const itemsDiv = document.getElementById("items");
                itemsDiv.addEventListener("input", calculateTotal);
                calculateTotal(); // 初期計算
            });
            
            function reindexItems() {
            	  const rows = document.querySelectorAll("#items tbody tr");
            	  rows.forEach((row, i) => {
            	    row.querySelectorAll("input[name]").forEach(input => {
            	      input.name = input.name.replace(/items\[\d+\]/, `items[${i}]`);
            	    });
            	  });
            	}
            	document.getElementById("editForm").addEventListener("submit", reindexItems);
        </script>
  </div>


</body>

</html>